I"é-<h2 id="what-is-the-kubernetes-control-plane">What is the Kubernetes Control Plane?</h2>

<p>The kubernetes control plane is a set of services that control the Kubernetes cluster.</p>

<p>Control Plane components ‚Äúmake global decisions about the cluster (e.g. scheduling) and detect and respond to cluster events (e.g. starting up a new pod when a replication controlle‚Äôs replicas field is unsatisfied)‚Äù</p>

<p>Control Plane components:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">kube-apiserver</code>: serves the kubernetes API, this allows users to interact with the cluster (kubectl communicates with the cluster using the API)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">etcd</code>: Not part of Kubernetes, but it is essential to Kubernetes Control Plane, as Kubernetes uses it as a distributed datastore.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">kube-scheduler</code>: Schedules pods on available worker nodes.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">kube-controller-manager</code>: Runs a series of controllers that provide a wide range of functionality. It combines all of those into a single process.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">cloud-controller-manager</code>: Handles interaction with underlying cloud providers (Azure, AWS, Google Cloud, hybrid, etc‚Ä¶). (Not going to be used)</p>
  </li>
</ul>

<p>These control plane components need to be installed on each controller node.</p>

<h3 id="installing-kubernetes-control-plane">Installing Kubernetes Control Plane</h3>

<p>First, let‚Äôs install the control plane binaries on each control node:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/kubernetes/config

wget <span class="nt">-q</span> <span class="nt">--show-progress</span> <span class="nt">--https-only</span> <span class="nt">--timestamping</span> <span class="se">\</span>
  <span class="s2">"https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-apiserver"</span> <span class="se">\</span>
  <span class="s2">"https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-controller-manager"</span> <span class="se">\</span>
  <span class="s2">"https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-scheduler"</span> <span class="se">\</span>
  <span class="s2">"https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kubectl"</span>

<span class="nb">chmod</span> +x kube-apiserver kube-controller-manager kube-scheduler kubectl

<span class="nb">sudo mv </span>kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/
</code></pre></div></div>

<h3 id="setting-up-the-kubernetes-api-server">Setting up the Kubernetes API Server</h3>

<p>This is going to be the directory for us to store some important files kubernetes is going to need.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/kubernetes/

<span class="nb">sudo cp </span>ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem <span class="se">\</span>
  service-account-key.pem service-account.pem <span class="se">\</span>
  encryption-config.yaml /var/lib/kubernetes/
</code></pre></div></div>

<p>Then, let‚Äôs setup some environment variables that will be used to create the <code class="highlighter-rouge">systemd</code> unit file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">INTERNAL_IP</span><span class="o">=</span><span class="si">$(</span>curl http://169.254.169.254/latest/meta-data/local-ipv4<span class="si">)</span> <span class="c"># this could have been set manually</span>
<span class="nv">CONTROLLER0_IP</span><span class="o">=</span>172.31.98.105
<span class="nv">CONTROLLER1_IP</span><span class="o">=</span>172.31.105.100
</code></pre></div></div>

<p>Then, generate the <code class="highlighter-rouge">kube-apiserver</code> unit file for <code class="highlighter-rouge">systemd</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | sudo tee /etc/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-apiserver </span><span class="se">\\</span><span class="sh">
  --advertise-address=</span><span class="k">${</span><span class="nv">INTERNAL_IP</span><span class="k">}</span><span class="sh"> </span><span class="se">\\</span><span class="sh">
  --allow-privileged=true </span><span class="se">\\</span><span class="sh">
  --apiserver-count=3 </span><span class="se">\\</span><span class="sh">
  --audit-log-maxage=30 </span><span class="se">\\</span><span class="sh">
  --audit-log-maxbackup=3 </span><span class="se">\\</span><span class="sh">
  --audit-log-maxsize=100 </span><span class="se">\\</span><span class="sh">
  --audit-log-path=/var/log/audit.log </span><span class="se">\\</span><span class="sh">
  --authorization-mode=Node,RBAC </span><span class="se">\\</span><span class="sh">
  --bind-address=0.0.0.0 </span><span class="se">\\</span><span class="sh">
  --client-ca-file=/var/lib/kubernetes/ca.pem </span><span class="se">\\</span><span class="sh">
  --enable-admission-plugins=Initializers,NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota </span><span class="se">\\</span><span class="sh">
  --enable-swagger-ui=true </span><span class="se">\\</span><span class="sh">
  --etcd-cafile=/var/lib/kubernetes/ca.pem </span><span class="se">\\</span><span class="sh">
  --etcd-certfile=/var/lib/kubernetes/kubernetes.pem </span><span class="se">\\</span><span class="sh">
  --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem </span><span class="se">\\</span><span class="sh">
  --etcd-servers=https://</span><span class="nv">$CONTROLLER0_IP</span><span class="sh">:2379,https://</span><span class="nv">$CONTROLLER1_IP</span><span class="sh">:2379 </span><span class="se">\\</span><span class="sh">
  --event-ttl=1h </span><span class="se">\\</span><span class="sh">
  --experimental-encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml </span><span class="se">\\</span><span class="sh">
  --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem </span><span class="se">\\</span><span class="sh">
  --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem </span><span class="se">\\</span><span class="sh">
  --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem </span><span class="se">\\</span><span class="sh">
  --kubelet-https=true </span><span class="se">\\</span><span class="sh">
  --runtime-config=api/all </span><span class="se">\\</span><span class="sh">
  --service-account-key-file=/var/lib/kubernetes/service-account.pem </span><span class="se">\\</span><span class="sh">
  --service-cluster-ip-range=10.32.0.0/24 </span><span class="se">\\</span><span class="sh">
  --service-node-port-range=30000-32767 </span><span class="se">\\</span><span class="sh">
  --tls-cert-file=/var/lib/kubernetes/kubernetes.pem </span><span class="se">\\</span><span class="sh">
  --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem </span><span class="se">\\</span><span class="sh">
  --v=2 </span><span class="se">\\</span><span class="sh">
  --kubelet-preferred-address-types=InternalIP,InternalDNS,Hostname,ExternalIP,ExternalDNS
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Last line was added to add the order of priority of the servers that determines how the kubeletes return their ip addresses, we give preference to the internal ip, otherwise they might report an IP address that might not work. Things may break without that flag:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--kubelet-preferred-address-types=InternalIP,InternalDNS,Hostname,ExternalIP,ExternalDNS
</code></pre></div></div>

<h3 id="setting-up-the-kubernetes-controller-manager">Setting up the Kubernetes Controller Manager</h3>

<p>First thing, let‚Äôs move this file to a location since it‚Äôs going to be needed by the kubernetes controller manager</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp </span>kube-controller-manager.kubeconfig /var/lib/kubernetes/
</code></pre></div></div>

<p>Then, let‚Äôs generate the kube-controller-manager systemd unit file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | sudo tee /etc/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-controller-manager </span><span class="se">\\</span><span class="sh">
  --address=0.0.0.0 </span><span class="se">\\</span><span class="sh">
  --cluster-cidr=10.200.0.0/16 </span><span class="se">\\</span><span class="sh">
  --cluster-name=kubernetes </span><span class="se">\\</span><span class="sh">
  --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem </span><span class="se">\\</span><span class="sh">
  --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem </span><span class="se">\\</span><span class="sh">
  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\\</span><span class="sh">
  --leader-elect=true </span><span class="se">\\</span><span class="sh">
  --root-ca-file=/var/lib/kubernetes/ca.pem </span><span class="se">\\</span><span class="sh">
  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem </span><span class="se">\\</span><span class="sh">
  --service-cluster-ip-range=10.32.0.0/24 </span><span class="se">\\</span><span class="sh">
  --use-service-account-credentials=true </span><span class="se">\\</span><span class="sh">
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>

<h3 id="setting-up-the-kubernetes-scheduler">Setting up the Kubernetes Scheduler</h3>

<p>Move the file of the kube-scheduler into place:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp </span>kube-scheduler.kubeconfig /var/lib/kubernetes/
</code></pre></div></div>

<p>Now, we need to create a yaml configuration file for the scheduler:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | sudo tee /etc/kubernetes/config/kube-scheduler.yaml
apiVersion: componentconfig/v1alpha1
kind: KubeSchedulerConfiguration
clientConnection:
  kubeconfig: "/var/lib/kubernetes/kube-scheduler.kubeconfig"
leaderElection:
  leaderElect: true
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="resources">Resources</h4>

<p><a href="https://kubernetes.io/docs/concepts/overview/components/#master-components">Kubernetes components</a></p>
:ET