<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Kubernetes Cluster from Scratch - Part 5 | Icaro’s Tech Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Kubernetes Cluster from Scratch - Part 5" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is my personal tech blog. Here I share my learnings, guides and insights about projects I’m working on." />
<meta property="og:description" content="This is my personal tech blog. Here I share my learnings, guides and insights about projects I’m working on." />
<link rel="canonical" href="http://localhost:4000/infrastructure/kubernetes-cluster-from-scratch-part-5/" />
<meta property="og:url" content="http://localhost:4000/infrastructure/kubernetes-cluster-from-scratch-part-5/" />
<meta property="og:site_name" content="Icaro’s Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-27T07:25:31+01:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/infrastructure/kubernetes-cluster-from-scratch-part-5/","headline":"Kubernetes Cluster from Scratch - Part 5","dateModified":"2019-12-27T07:25:31+01:00","datePublished":"2019-12-27T07:25:31+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/infrastructure/kubernetes-cluster-from-scratch-part-5/"},"description":"This is my personal tech blog. Here I share my learnings, guides and insights about projects I’m working on.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Icaro's Tech Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Icaro&#39;s Tech Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About me</a><a class="page-link" href="/quotes">Quotes</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Kubernetes Cluster from Scratch - Part 5</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-12-27T07:25:31+01:00" itemprop="datePublished">Dec 27, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="setting-up-kubernetes-remote-access-and-kubectl">Setting up Kubernetes Remote Access and kubectl</h2>

<p>We’ve already used kubectl to generate the kubeconfigs and some verification steps.</p>

<p>Kubectl is the kubernetes command line tool, it allows us to interact with Kubernetes clusters from the command line.</p>

<p>We will set up kubectl to allow remote access from our machine in order to manage the cluster remotely.</p>

<p>To do this, we will generate a local kubeconfig that will authenticate as the admin user and access the Kubernetes API through the load balancer.</p>

<h4 id="resources">Resources</h4>

<ul>
  <li><a href="https://kubernetes.io/docs/reference/kubectl/overview/">Kubectl</a></li>
</ul>

<h2 id="configuring-kubectl-for-remote-access">Configuring kubectl for remote access</h2>

<p>Open a ssh tunnel to port 6443 on the kubernetes API load balancer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">LOAD_BALANCER_IP</span><span class="o">=</span>172.31.108.99
<span class="nv">CLOUD_USER</span><span class="o">=</span>cloud_user

ssh <span class="nt">-L</span> 6443:localhost:6443 <span class="k">${</span><span class="nv">CLOUD_USER</span><span class="k">}</span>@<span class="k">${</span><span class="nv">LOAD_BALANCER_IP</span><span class="k">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/kthw

<span class="c"># set up a new kubernetes cluster in the local configuration for kubectl</span>
kubectl config set-cluster kubernetes-the-hard-way <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span>https://localhost:6443

<span class="c"># this is going to work because of the ssh tunnel, the traffic will be forwarded through the ssh tunnel to the load balancer</span>
kubectl config set-credentials admin <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>admin.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>admin-key.pem

<span class="c"># a context is just a set of data we use to connect to a server</span>
kubectl config set-context kubernetes-the-hard-way <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes-the-hard-way <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>admin

kubectl config use-context kubernetes-the-hard-way
</code></pre></div></div>

<p>Then, we can verify that everything is working:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># for now, there are no pods, but it should return no resources found</span>
kubectl get pods

<span class="c"># should return the two worker nodes</span>
kubectl get nodes

<span class="c"># will return client and server version</span>
kubectl version
</code></pre></div></div>

<h2 id="networking">Networking</h2>

<p>Kubernetes provides a powerful networking model which allows pods to communicate with one another over a virtual network.</p>

<h3 id="what-problems-does-the-networking-model-solve">What problems does the networking model solve?</h3>

<ul>
  <li>
    <p>How will containers communicate with each other?</p>
  </li>
  <li>
    <p>What if the containers are on different hosts (worker nodes)?</p>
  </li>
  <li>
    <p>How will containers communicate with services?</p>
  </li>
  <li>
    <p>How will containers be assigned unique IP addresses?</p>
  </li>
</ul>

<h3 id="the-docker-model">The Docker Model</h3>

<p>Kubernetes Model is a response to the Docker Model</p>

<p>Docker allows containers to communicate with one another using a virtual network bridge configured on the host.</p>

<p>Each host has its own virtual network serving all the containers on that host. But we run on problems when we have containers on different hosts, then we have to proxy the traffic from the host to the containers, also making sure that no two containers use the same port on a host.</p>

<p>The Kubernetes networking model was created to overcome those limitations.</p>

<h3 id="the-kubernetes-networking-model">The Kubernetes Networking Model</h3>

<ul>
  <li>
    <p>One virtual network for the whole cluster</p>
  </li>
  <li>
    <p>Each pod has a unique IP within the cluster</p>
  </li>
  <li>
    <p>Each service has a unique IP that is in a different range than pod IPs.</p>
  </li>
</ul>

<h4 id="resources-1">Resources</h4>

<ul>
  <li><a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">Networking</a></li>
</ul>

<h2 id="cluster-network-architecture">Cluster Network Architecture</h2>

<p>CIDR is a way of allocating IP addresses, and it has a way to specifying a CIDR range.</p>

<ul>
  <li>
    <p>Cluster CIDR: value that we will pass to kubernetes and it tells kubernetes what ip range to use when setting up the network (we’ve used it already when setting up some services: example: systemd unit file for the kube-controller-manager, you can see the flag, cluster cidr)</p>
  </li>
  <li>
    <p>Service Cluster IP Range: ip range for services in the cluster, should <strong>not</strong> overlap with the cluster CIDR range.</p>
  </li>
  <li>
    <p>Pod CIDR: we don’t specify a pod CIDR manually in this guide. the pod CIDR is an ip range for pods on a <strong>specific worker node</strong>, need to fall within the cluster CIDR, but can’t overlap with the pod CIDR for any other nodes. So we are allocating to each node a range of IPs.</p>
    <ul>
      <li>Our networking solution automatically handles this.</li>
    </ul>
  </li>
</ul>

<h4 id="resources-2">Resources</h4>

<ul>
  <li><a href="https://github.com/weaveworks/weave">Weave</a></li>
</ul>

  </div><div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://isfonzar.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            <a class="u-url" href="/infrastructure/kubernetes-cluster-from-scratch-part-5/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Icaro&#39;s Tech Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Icaro&#39;s Tech Blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/isfonzar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">isfonzar</span></a></li><li><a href="https://www.twitter.com/isfonzar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">isfonzar</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This is my personal tech blog. Here I share my learnings, guides and insights about projects I&#39;m working on.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
